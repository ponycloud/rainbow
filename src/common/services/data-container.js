// Generated by CoffeeScript 1.6.3
(function() {
  var factoryFunction, module;

  module = angular.module('rainbowServices');

  factoryFunction = function(auth, $q, $rootScope, WS_URL) {
    return {
      data: {},
      abSession: $q.defer(),
      registerEntity: function(type, entity) {
        var item, _i, _len, _results;
        this.data[type] = {
          'collection': entity,
          'items': {}
        };
        _results = [];
        for (_i = 0, _len = entity.length; _i < _len; _i++) {
          item = entity[_i];
          _results.push(this.data[type]['items'][item.desired.uuid] = item);
        }
        return _results;
      },
      setEntity: function(type, uuid, entity) {
        var _this = this;
        return $rootScope.$apply(function() {
          if (!entity.desired && !entity.current) {
            _this.data[type]['collection'].splice(_this.data[type]['collection'].indexOf(_this.data[type]['items'][uuid]), 1);
            return delete _this.data[type]['items'][uuid];
          } else if (_this.getEntity(type, uuid)) {
            return angular.copy(entity, _this.data[type]['items'][uuid]);
          } else {
            if (_this.data[type]) {
              _this.data[type]['collection'].push(entity);
              return _this.data[type]['items'][uuid] = entity;
            }
          }
        });
      },
      getEntity: function(type, uuid) {
        if (this.data[type]) {
          return this.data[type]['items'][uuid];
        }
      },
      listenSocket: function() {
        return ab.connect(WS_URL, this._socketConnected, ab.log, {
          'caller': this
        });
      },
      subscribeTenant: function(tenant) {
        var _this = this;
        return this.abSession.promise.then(function() {
          return _this.session.auth(auth.getTenantToken(tenant)).then(function(permissions) {
            return _this.session.subscribe(permissions['pubsub'][1].uri, (function(topic, event) {
              return _this._onNewMessage(topic, event);
            }), ab.log);
          });
        });
      },
      _socketConnected: function(session) {
        this.options.caller.session = session;
        return this.options.caller.abSession.resolve();
      },
      _onNewMessage: function(topic, event) {
        return this.setEntity(event.type, event.pkey, {
          current: event.current,
          desired: event.desired
        });
      }
    };
  };

  module.factory('dataContainer', factoryFunction);

}).call(this);
