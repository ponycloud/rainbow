// Generated by CoffeeScript 1.6.3
(function() {
  var factoryFunction, module;

  module = angular.module('rainbowServices');

  factoryFunction = function(auth, $q, $rootScope, WS_URL) {
    return {
      data: {},
      registerEntity: function(type, entity) {
        var item, _i, _len, _results;
        this.data[type] = {
          'collection': entity,
          'items': {}
        };
        _results = [];
        for (_i = 0, _len = entity.length; _i < _len; _i++) {
          item = entity[_i];
          _results.push(this.data[type]['items'][item.desired.uuid] = item);
        }
        return _results;
      },
      setEntity: function(type, uuid, entity) {
        var me;
        me = this;
        return $rootScope.$apply(function() {
          if (!entity.desired && !entity.current) {
            me.data[type]['collection'].splice(me.data[type]['collection'].indexOf(me.data[type]['items'][uuid]), 1);
            return delete me.data[type]['items'][uuid];
          } else if (me.getEntity(type, uuid)) {
            return angular.copy(entity, me.data[type]['items'][uuid]);
          } else {
            if (me.data[type]) {
              me.data[type]['collection'].push(entity);
              return me.data[type]['items'][uuid] = entity;
            }
          }
        });
      },
      getEntity: function(type, uuid) {
        if (this.data[type]) {
          return this.data[type]['items'][uuid];
        }
      },
      listenSocket: function() {
        return ab.connect(WS_URL, this._socketConnected, ab.log, {
          'caller': this
        });
      },
      _socketConnected: function(session) {
        var me;
        me = this;
        console.log('connected ws');
        return session.auth(auth.getUserToken()).then(function(permissions) {
          var container, notifyUri;
          notifyUri = permissions['pubsub'][0].uri;
          container = me.options.caller;
          return session.subscribe(notifyUrl, (function(topic, event) {
            return container._onNewMessage(topic, event);
          }), ab.log);
        });
      },
      _onNewMessage: function(topic, event) {
        return this.setEntity(event.type, event.pkey, {
          current: event.current,
          desired: event.desired
        });
      }
    };
  };

  module.factory('dataContainer', factoryFunction);

}).call(this);
