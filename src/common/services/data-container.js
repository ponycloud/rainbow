// Generated by CoffeeScript 1.7.1
(function() {
  var factoryFunction, module;

  module = angular.module('rainbowServices');

  factoryFunction = function(auth, $q, $rootScope, WS_URL) {
    return {
      data: {},
      abSession: $q.defer(),
      registerResource: function(resource, pkey) {
        return this.data[pkey] = resource;
      },
      registerEntity: function(type, entity) {
        if (this.data[type] === void 0) {
          return this.data[type] = [
            {
              'collection': entity,
              'items': new function() {
                var item, _i, _len, _ref;
                _ref = $(entity);
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  item = _ref[_i];
                  this[item.pkey] = item;
                }
                return this;
              }
            }
          ];
        } else {
          return this.data[type].push({
            'collection': entity,
            'items': new function() {
              var item, _i, _len, _ref;
              _ref = $(entity);
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                item = _ref[_i];
                this[item.pkey] = item;
              }
              return this;
            }
          });
        }
      },
      setEntity: function(type, pkey, entity) {
        return $rootScope.$apply((function(_this) {
          return function() {
            var col;
            if (!entity.desired && !entity.current) {
              for (col in _this.data[type]) {
                _this.data[type][col]['collection'].splice(_this.data[type][col]['collection'].indexOf(_this.data[type][col]['items'][pkey]), 1);
                delete _this.data[type][col]['items'][pkey];
              }
              return delete _this.data[pkey];
            } else {
              for (col in _this.data[type]) {
                if (_this.data[type][col]['items'][pkey] !== void 0) {
                  angular.copy(entity, _this.data[type][col]['items'][pkey]);
                } else {
                  _this.data[type][col]['collection'].push(entity);
                  if (_this.data[type][col]['items'][pkey] === void 0) {
                    _this.data[type][col]['items'][pkey] = entity;
                  } else {
                    angular.extend(_this.data[type][col]['items'][pkey], entity);
                  }
                }
              }
              if (_this.data[pkey]) {
                return angular.extend(_this.data[pkey], entity);
              }
            }
          };
        })(this));
      },
      listenSocket: function() {
        return ab.connect(WS_URL, this._socketConnected, ab.log, {
          'caller': this
        });
      },
      subscribeTenant: function(tenant) {
        return this.abSession.promise.then((function(_this) {
          return function() {
            return auth.getTenantToken(tenant).then(function(tenantToken) {
              return _this.session.auth(tenantToken).then(function(permissions) {
                return _this.session.subscribe(permissions['pubsub'][1].uri, (function(topic, event) {
                  return _this._onNewMessage(topic, event);
                }), ab.log);
              });
            });
          };
        })(this));
      },
      _socketConnected: function(session) {
        this.options.caller.session = session;
        return this.options.caller.abSession.resolve();
      },
      _onNewMessage: function(topic, event) {
        console.log(topic, event);
        return this.setEntity(event.type, event.pkey, {
          current: event.current,
          desired: event.desired,
          pkey: event.pkey
        });
      }
    };
  };

  module.factory('dataContainer', factoryFunction);

}).call(this);
